def ReplaceLetter(string, letter, index):
    return "".join((string[:index], letter, string[index + 1:]))

def Time(time):
    result = 0
    hours = int(time[0:2])
    minutes = int(time[3:5])
    seconds = int(time[6:8])
    meleeseconds = int(time[9:12])
    return hours * 3600 + minutes * 60 + seconds + meleeseconds / 1000

def ParagraphFormatter(startTimings, endTimings, lines):
    lines[0] = ReplaceLetter(lines[0], lines[0][0].upper(), 0) + ' '
    for i in range(1, len(lines) - 1):
        isParagraph = endTimings[i - 1] < startTimings[i]
        if isParagraph:
            if lines[i-1][-1] == ' ':
                lines[i-1] = lines[i-1][:-1] + '.\n'
            else:
                lines[i-1] += '.\n'
            lines[i] = ReplaceLetter(lines[i], lines[i][0].upper(), 0) + ' '
        else:
            lines[i] = lines[i] + ' '

    isParagraph = endTimings[-2] < startTimings[-1]
    if isParagraph:
        if lines[-1][-1] == ' ':
            lines[-1] = lines[-2][:-1] + '.\n'
        else:
            lines[-1] += '.'
        lines[-1] = ReplaceLetter(lines[-1], lines[-1][0].upper(), 0) + ' '
    else:
        lines[-1] = lines[-1] + '.'

    return lines

def TextFormater(data):
    caption = data[0]
    language = data[2]
    
    if data[0] == 'Субтитры отсутствуют':
        return data[0]
    
    startTimings = []
    endTimings = []
    lines = []
    
    counter = 0
    line = ''
    for i in caption:
        if i != "\n":
            line += i
        else:
            counter += 1
            if counter % 4 == 2:
                startTimings.append(Time(line[:12]))
                endTimings.append(Time(line[-12:]))
            if counter % 4 == 3:
                if line[0] == '[' or line[-1] == ']':
                    startTimings.pop()
                    endTimings.pop()
                else:
                    lines.append(line)
            line = ''

    if language[0:2] == 'a.':
        lines = ParagraphFormatter(startTimings, endTimings, lines)

    data = []

    for line in lines:
        #print(line)
        words = line.split(' ')
        #print(words)
        for word in words:
            if word != '':
                if word[-1] == '\n':
                    data.append([word[:-2], word[:-2], 0, 0])
                elif word[-1] in '.,!?':
                    data.append([word[:-1], word[-1], 0, 0])
                else:
                    data.append([word, '', 0, 0])

    return data
