import PySimpleGUI as gui
import subtitle as sub
import text_formatter as tf
import pyperclip as clipboard
import easygui as gui2

layout = [
	[gui.Text('Введите ссылку на видео'), gui.InputText(key = 'link'), 
	gui.Button('Вставить ссылку', key = 'paste')],
	[gui.Button('Скачать и отформатировать субтитры', key = 'submit')],
	[gui.Multiline(size = (88, 20), key = 'output')],
	[gui.Button('Скопировать текст', key = 'copy'), 
	gui.Button('Сохранить текст', key = 'save'),
	gui.Text('', size = (30, 1), key = 'logger')]
]

gui.theme('DarkAmber')
window = gui.Window('Конвертация видео в статью', layout)

def logger(message):
	window['logger'].update(value = message)

def update(link):
	logger('Загрузка субтитров')
	caption_data = sub.DownloadCaption(link)
	logger('Форматирование текста')
	text = tf.TextFormater(caption_data)
	logger('Вывод')
	window['output'].update(value = '')
	window['output'].print(text)
	logger('Текст готов')

def copy(text):
	title = text.partition('\n')[0]
	clipboard.copy(values['output'][len(title) + 1:-1])
	logger('Текст скопирован')

def paste():
	return clipboard.paste()

def save(text):
	title = text.partition('\n')[0]
	if(title != ''):
		open(gui2.filesavebox(default = title + '.txt'), 'w').write(text)
	logger('Текст сохранён')

while True:
	event, values = window.read()
	#print(event, values) #debug
	if event in (None, 'Exit', 'Cancel'):
		break
	if event == 'submit':
		update(values['link'])
	if event == 'copy':
		copy(values['output'])
	if event == 'paste':
		window['link'].update(paste())
	if event == 'save':
		save(values['output'])
