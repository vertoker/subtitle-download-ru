import PySimpleGUI as gui
import subtitle as sub
import NLP_AI as ai
import text_formatter as tf
import pyperclip as clipboard
import easygui as gui2

layout = [
	[gui.Text('Введите ссылку на видео'), gui.InputText(key = 'link'),
	gui.Button('Вставить ссылку', key = 'paste')],
	[gui.Button('Скачать и отформатировать субтитры', key = 'submit')],
	[gui.Multiline(size = (88, 20), key = 'output')],
	[gui.Button('Скопировать текст', key = 'copy'),
	gui.Button('Сохранить текст', key = 'save'),
	gui.Text('', size = (30, 1), key = 'logger')],
	[gui.Button('Сохранить файл субтитров', key = 'save-subtitle'),
	gui.Button('Сохранить файл субтитров в формате sbv', key = 'save-youtube-subtitle')]
]

data = []

gui.theme('DarkAmber')
window = gui.Window('Конвертация видео в статью', layout)

def logger(message):
	window['logger'].update(value = message)

def update(link):
	logger('Загрузка субтитров')
	caption, name, language = sub.DownloadCaption(link)
	logger('Форматирование текста')
	dataText = tf.TextFormater(caption, language)
	logger('Расстановка пунктуации нейросетью')
	text = ai.PunctuationFormatter(dataText)
	global data
	data = [text, name, caption]
	logger('Вывод')
	window['output'].update(value = '')
	window['output'].print(name + '\n' + text)
	logger('Текст готов')

def copy():
	clipboard.copy(values['output'])
	logger('Текст скопирован')

def paste():
	return clipboard.paste()

def save():
	if (data[1] != ''):
		open(gui2.filesavebox(default = data[1] + '.txt'), 'w').write(data[0])
	logger('Текст сохранён')

def save_subtitle():
	if (data[1] != ''):
		open(gui2.filesavebox(default = data[1] + ' sub.srt'), 'w').write(data[2])
	logger('Файл субтитров сохранён')

def save_youtube_subtitle():
	if (data[1] != ''):
		open(gui2.filesavebox(default = data[1] + ' sbv.sbv'), 'w').write(sub.Caption2sbv(data[2]))
	logger('Файл субтитров сохранён')

while True:
	event, values = window.read()
	#print(event, values) #debug
	if event in (None, 'Exit', 'Cancel'):
		break
	if event == 'submit':
		update(values['link'])
	if event == 'copy':
		copy()
	if event == 'paste':
		window['link'].update(paste())
	if event == 'save':
		save()
	if event == 'save-subtitle':
		save_subtitle()
	if event == 'save-youtube-subtitle':
		save_youtube_subtitle()
